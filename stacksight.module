<?php

require('stacksight-php-sdk/platforms/SSDrupalClient.php');

function stacksight_admin() {
	$form = array();

	$form['stacksight_app'] = array(
		'#type' => 'textfield',
		'#title' => t('App'),
		'#default_value' => variable_get('stacksight_app', ''),
		'#size' => 64,
		'#maxlength' => 64,
		'#description' => t("An app name within mean network"),
		'#required' => TRUE,
	);

	$form['stacksight_token'] = array(
		'#type' => 'textfield',
		'#title' => t('Access Token'),
		'#default_value' => variable_get('stacksight_token', ''),
		'#size' => 64,
		'#maxlength' => 64,
		'#description' => t("An access token given by mean network"),
		'#required' => TRUE,
	);
	$form['#submit'][] = 'stacksight_admin_submit';

	return system_settings_form($form);
}

function stacksight_menu() {
	$items = array();

	$items['admin/config/development/stacksight'] = array(
		'title' => 'StackSight',
		'description' => 'StackSight integration module settings',
		'page callback' => 'drupal_get_form',
		'page arguments' => array('stacksight_admin'),
		'access arguments' => array('administer stacksight settings'),
		'weight' => -5,
	);

	return $items;
}

function stacksight_permission() {
	return array(
		'administer stacksight settings' => array(
			'title' => t('Administer StackSight settings')
		),
	);
}

function stacksight_admin_submit($form, &$form_state) {
	$app_name = $form_state['values']['stacksight_app'];
	$token = $form_state['values']['stacksight_token'];

	$ss_client = new SSDrupalClient($token, 'drupal');
	$result = $ss_client->initApp($app_name);

	if ($result['success']) {
		if ($result['message'] != 'LOADED') drupal_set_message('The app "'.$result['data']['name'].'" created successfully');
	} else drupal_set_message($result['message'], 'error');
}

function stacksight_watchdog($log) {
	$app_name = variable_get('stacksight_app');
	$token = variable_get('stacksight_token');

	if (!$app_name || !$token) return;

	$ss_client = new SSDrupalClient($token, 'drupal');
	$app = $ss_client->initApp($app_name);
	if (!$app['success']) {
		SSUtilities::error_log($app['message'], 'error');
		return;
	}

	$data = array();
	$data['key'] = $log['type'];
	$data['name'] = t(str_replace("%", "@", $log['message']), json_decode(str_replace('%', '@',  json_encode($log['variables'])), true) );
	$data['data']['description'] = $data['name'];

	switch ($log['type']) {
	    case 'content':
	        $data['design']['icon'] = 'fa-file-text';
	        $data['design']['color'] = '#8FD5FF';
	        break;
	    case 'user':
	       $data['design']['icon'] = 'fa-user';
	       $data['design']['color'] = '#8664aa';
	        break;
	    case 'php':
	    	$data['design']['icon'] = 'fa-code';
	      	$data['design']['color'] = '#990000';
	        break;
	    case 'system':
	       $data['design']['icon'] = 'fa-cubes';
	       $data['design']['color'] = '#c79696';
	        break;
	    case 'actions':
	       $data['design']['icon'] = 'fa-certificate';
	       $data['design']['color'] = '#fd8e00';
	        break;
	    case 'cron':
	       $data['design']['icon'] = 'fa-cogs';
	       $data['design']['color'] = '#de1b16';
	        break;
	    default:
	        $data['design']['color'] = '#19617a';
	        $data['design']['icon'] = 'fa-bars';
	        break;
	}

	$res = $ss_client->publishEvent($data);
	if (!$res['success']) SSUtilities::error_log($res['message'], 'error');
}

function stacksight_uninstall() {
	variable_del('stacksight');
	variable_del('stacksight_app');
	variable_del('stacksight_token');
}